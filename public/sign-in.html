<!DOCTYPE html>
<html lang="ja" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <title>Share Timer Sign In</title>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth__ja.js"></script>
    <script>
      const port = Number(new URLSearchParams(location.search).get("emulator"))
      if (port) {
        const protocol = location.protocol
        const host = location.hostname

        firebase.auth().useEmulator(`${protocol}//${host}:${port}`)
      }

      customElements.define(
        "firebaseui-auth",
        class FirebaseuiAuth extends HTMLElement {
          constructor() {
            super()

            const shadowRoot = this.attachShadow({ mode: "open" })

            const link = shadowRoot.appendChild(document.createElement("link"))
            link.rel = "stylesheet"
            link.href =
              "https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css"

            const style = shadowRoot.appendChild(
              document.createElement("style")
            )
            style.textContent = `
              button:focus {
                /* https://css-tricks.com/copy-the-browsers-native-focus-styles/ */
                outline: Highlight auto medium;
                outline: -webkit-focus-ring-color auto medium;
              }
            `

            const ui = new firebaseui.auth.AuthUI(firebase.auth())
            const container = shadowRoot.appendChild(
              document.createElement("div")
            )

            ui.start(container, {
              signInSuccessUrl:
                new URLSearchParams(location.search).get("back") ||
                location.href,
              signInOptions: [
                firebase.auth.GoogleAuthProvider.PROVIDER_ID,
                // "apple.com",
                // "microsoft.com",
                // "yahoo.com",
                // firebase.auth.FacebookAuthProvider.PROVIDER_ID,
                // firebase.auth.TwitterAuthProvider.PROVIDER_ID,
                // firebase.auth.GithubAuthProvider.PROVIDER_ID,
                // firebase.auth.EmailAuthProvider.PROVIDER_ID,
                // firebase.auth.PhoneAuthProvider.PROVIDER_ID,
                // firebaseui.auth.AnonymousAuthProvider.PROVIDER_ID,
              ],
            })
          }
        }
      )
    </script>

    <script type="module">
      import {
        html,
        render,
        useState,
        useEffect,
      } from "https://unpkg.com/htm@3.1.1/preact/standalone.module.js"

      function App() {
        const [user, setUser] = useState(firebase.auth().currentUser)

        useEffect(
          () =>
            firebase.auth().onAuthStateChanged((user) => {
              setUser(user)
            }),
          []
        )

        if (!user) {
          return null
        }

        const onsubmit = (e) => {
          e.preventDefault()
          firebase.auth().signOut()
        }

        const {
          uid,
          email,
          displayName,
          lastLoginAt,
          providerData: [provider],
        } = user

        const info = [
          ["アカウント", provider?.providerId],
          ["名前", displayName],
          ["メール", email],
        ]

        return html`
          <main style="text-align: center">
            <form onsubmit=${onsubmit}>
              <table>
                <tbody>
                  ${info.map(
                    ([key, value]) =>
                      html`
                        <tr>
                          <th>${key}</th>
                          <td>${value || "-"}</td>
                        </tr>
                      `
                  )}
                </tbody>
              </table>

              <p>
                <button>ログアウト</button>
              </p>
            </form>
          </main>
        `
      }

      render(html`<${App} />`, document.getElementById("root"))
    </script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/awsm.css@3.0.7/dist/awsm.min.css"
    />
    <style>
      :not(:empty) + .peer-hidden {
        display: none;
      }
    </style>
  </head>

  <body>
    <header style="text-align: center">
      <h1>Share Timer</h1>
    </header>

    <div id="root"></div>

    <firebaseui-auth class="peer-hidden"></firebaseui-auth>
  </body>
</html>
